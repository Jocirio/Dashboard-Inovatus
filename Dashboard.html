<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Dashboard UPA ‚Äì Atendimentos (Final)</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root{
        --bg:#0b0f12;
        --card:#0f1416;
        --muted:#9aa6a6;
        --accent:#0a84ff; /* azul */
        --pink:#ff6b9a; /* rosa */
        --text:#e6f0f3;
    }
    html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter, Arial, sans-serif}
    header{background:linear-gradient(90deg,#06121a, #0f1b22);padding:16px 24px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{margin:0;font-size:20px;color:var(--text)}
    .content{padding:18px;max-width:1300px;margin:0 auto}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    select,input[type="file"],button{background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px}
    button{cursor:pointer}

    .cards{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.6);}
    .card .label{color:var(--muted);font-size:13px}
    .card .value{font-size:20px;font-weight:700;margin-top:6px}
    .value.blue{color:var(--accent)}
    .value.pink{color:var(--pink)}

    .layout{display:grid;grid-template-columns: 1fr 420px;gap:16px}
    @media(max-width:980px){.layout{grid-template-columns:1fr}.cards{grid-template-columns:1fr 1fr}}
    .panel{background:var(--card);padding:12px;border-radius:10px}
    .chart-wrap{height:320px}
    canvas{width:100% !important;height:100% !important}

    .smallmuted{color:var(--muted);font-size:13px}
    .filters-block{display:flex;flex-direction:column;gap:8px}
    .multiselect{height:110px}
    .micro{font-size:12px;color:var(--muted)}

    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}
</style>
</head>
<body>
<header>
    <img src="/mnt/data/89178546_3311803332181122_2971419393696727040_n.jpg" alt="Logo" style="height:60px; margin-right:20px;">
    <h1>üè• Dashboard UPA ‚Äî Atendimentos (Dark)</h1>
    <div style="display:flex;gap:10px;align-items:center">
        <div class="micro">Arquivo(s) CSV</div>
        <input id="fileInput" type="file" accept=".csv" multiple />
    </div>

    <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
        <label>Data Inicial: <input type="date" id="dataInicio"></label>
        <label>Data Final: <input type="date" id="dataFim"></label>
        <button id="aplicarData">Aplicar</button>
        <button id="exportPNG">Exportar Gr√°fico (PNG)</button>
    </div>
</header>

<div class="content">

    <!-- CONTROLES GLOBAIS -->
    <div class="controls">
        <div style="min-width:320px;">
            <label class="smallmuted">Unidade (Filtro principal - afeta todos os gr√°ficos)</label><br>
            <select id="filtroUnidade" style="width:320px">
                <option value="">Todas as Unidades</option>
            </select>
        </div>

        <div>
            <label class="smallmuted">Sexo</label><br>
            <select id="filtroSexo">
                <option value="">Todos</option>
                <option value="Masculino">Masculino</option>
                <option value="Feminino">Feminino</option>
                <option value="N√ÉO INFORMADO">N√£o informado</option>
            </select>
        </div>

        <div>
            <label class="smallmuted">Faixa Et√°ria</label><br>
            <select id="filtroFaixa">
                <option value="">Todas</option>
                <option value="0-5">0‚Äì5</option>
                <option value="6-17">6‚Äì17</option>
                <option value="18-24">18‚Äì24</option>
                <option value="25-39">25‚Äì39</option>
                <option value="40-59">40‚Äì59</option>
                <option value="60-79">60‚Äì79</option>
                <option value="80+">80+</option>
                <option value="N/D">N/D</option>
            </select>
        </div>

        <div>
            <label class="smallmuted">Top N (Proced./Prof.)</label><br>
            <select id="topN">
                <option>Top 5</option>
                <option selected>Top 10</option>
                <option>Top 20</option>
            </select>
        </div>

        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button id="btnReset">Resetar Filtros</button>
            <button id="btnApply">Aplicar Filtros</button>
        </div>
    </div>

    <!-- CARDS -->
    <div class="cards">
        <div class="card">
            <div class="label">Total Atendimentos</div>
            <div id="kpiTotal" class="value">0</div>
        </div>
        <div class="card">
            <div class="label">M√©dia por dia</div>
            <div id="kpiMedia" class="value">0</div>
        </div>
        <div class="card">
            <div class="label">% Masculino / Feminino</div>
            <div id="kpiPctSexo" class="value"><span id="pctM" class="value blue">M: 0%</span> ¬∑ <span id="pctF" class="value pink">F: 0%</span></div>
        </div>
        <div class="card">
            <div class="label">Idade m√©dia</div>
            <div id="kpiIdade" class="value">N/D</div>
        </div>
        <div class="card">
            <div class="label">Unidade mais atendida</div>
            <div id="kpiTopUnidade" class="value">‚Äî</div>
        </div>
        <div class="card">
            <div class="label">Procedimento mais frequente</div>
            <div id="kpiTopProced" class="value">‚Äî</div>
        </div>
    </div>

    <!-- LAYOUT PRINCIPAL -->
    <div class="layout">
        <div>
            <div class="panel card">
                <h2>Total por dia</h2>
                <div class="chart-wrap"><canvas id="chartLineDay"></canvas></div>
            </div>

            <div class="panel card" style="margin-top:12px">
                <h2>Sexo</h2>
                <div class="chart-wrap"><canvas id="chartSexPie"></canvas></div>
            </div>

            <div class="panel card" style="margin-top:12px">
                <h2>Faixa Et√°ria</h2>
                <div class="chart-wrap"><canvas id="chartAgeBar"></canvas></div>
            </div>

            <div class="panel card" style="margin-top:12px">
                <h2>Top <span id="labelTopProc">10</span> Procedimentos</h2>
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                    <div class="smallmuted">Pesquisar procedimento:</div>
                    <input id="searchProc" placeholder="filtrar procedimentos" style="flex:1;padding:6px;border-radius:6px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--text)" />
                </div>
                <div class="chart-wrap"><canvas id="chartTopProc"></canvas></div>
            </div>

        </div>

        <aside>
            <div class="panel card">
                <h2>Top <span id="labelTopProf">10</span> Profissionais</h2>
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                    <div class="smallmuted">Pesquisar profissional:</div>
                    <input id="searchProf" placeholder="filtrar profissionais" style="flex:1;padding:6px;border-radius:6px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--text)" />
                </div>
                <div class="chart-wrap"><canvas id="chartTopProf"></canvas></div>
            </div>

            <div class="panel card" style="margin-top:12px">
                <h2>Unidade / Procedimento mais frequente</h2>
                <div style="padding:8px;color:var(--muted)">
                    <div><strong>Unidade mais atendida:</strong> <span id="mostUnit">‚Äî</span></div>
                    <div style="margin-top:6px"><strong>Procedimento mais frequente:</strong> <span id="mostProc">‚Äî</span></div>
                </div>
                <div style="margin-top:12px">
                    <div class="smallmuted">Filtrar a lista por Unidade (apenas para esta se√ß√£o):</div>
                    <select id="filterUnitForTop" style="width:100%;margin-top:8px;background:rgba(255,255,255,0.02);color:var(--text)"></select>
                </div>
            </div>
        </aside>
    </div>

    <footer>Abra este arquivo no navegador. Carregue v√°rios CSVs simultaneamente. Filtro principal por Unidade afeta todos os gr√°ficos. Layout mantido conforme solicitado.</footer>

</div>

<!-- SCRIPTS -->
<script>
// Estado global
let rawRows = [];
let rows = [];
let charts = {line:null, sex:null, age:null, topProc:null, topProf:null};

// Helpers
function findCol(cols, names){
    for(const cand of names){
        const l = cand.toLowerCase().trim();
        for(const c of cols){
            if(String(c).toLowerCase().trim() === l) return c;
        }
    }
    return null;
}

function normalizeRow(obj, cols){
    const get = (cands)=>{ const col = findCol(cols, cands); return col ? (obj[col]||'').toString().trim() : ''; };
    const sexoRaw = get(['Sexo','SEXO','sexo','Genero','G√äNERO','GENERO']);
    const idadeRaw = get(['Idade','IDADE','idade','IdadePaciente','Idade Paciente']);
    const unidade = get(['Unidade','UNIDADE','Local','LOCAL','Unidade Atendente']);
    const procedimento = get(['Procedimento','PROCEDIMENTO','Procedimento/Produto','Procedimento Nome','Procedimento ']);
    const profissional = get(['Profissional','PROFISSIONAL','Nome','Nome Profissional']);
    const dataAt = get(['Data Atendimento','DataAtendimento','Data','DATA','data','Data Atendimento']);
    const tipo = get(['Tipo Atendimento','Tipo_Atendimento','Tipo Atendimento','Tipo']);

    let s = sexoRaw.toUpperCase();
    let sexo = 'N√ÉO INFORMADO';
    if(s.startsWith('M')) sexo = 'Masculino'; else if(s.startsWith('F')) sexo = 'Feminino'; else if(s) sexo = sexoRaw;

    let idade = null; if(idadeRaw){ const digits = idadeRaw.replace(/[^0-9]/g,''); if(digits) idade = parseInt(digits); }

    // parse date
    let dateObj = null;
    if(dataAt){
        // try ISO / browser parse
        let d = new Date(dataAt);
        if(!isNaN(d)) dateObj = d; else {
            const d2 = new Date(dataAt.replace(' ', 'T'));
            if(!isNaN(d2)) dateObj = d2;
        }
    }

    let faixa = 'N/D';
    if(idade !== null && !isNaN(idade)){
        if(idade <=5) faixa='0-5'; else if(idade <=17) faixa='6-17'; else if(idade <=24) faixa='18-24'; else if(idade <=39) faixa='25-39'; else if(idade <=59) faixa='40-59'; else if(idade <=79) faixa='60-79'; else faixa='80+';
    }

    return {
        Sexo: sexo,
        Idade: idade,
        Faixa: faixa,
        Unidade: unidade || 'N√ÉO INFORMADO',
        Procedimento: procedimento || 'N√ÉO INFORMADO',
        Profissional: profissional || 'N√ÉO INFORMADO',
        DataAtendimento: dateObj,
        DataRaw: dataAt || '',
        TipoAtendimento: tipo || 'N√ÉO INFORMADO'
    };
}

// Parse m√∫ltiplos CSVs
const fileInput = document.getElementById('fileInput');
fileInput.addEventListener('change', (e)=>{
    rawRows = []; rows = [];
    const files = Array.from(e.target.files);
    if(!files.length) return;
    let pending = files.length;
    files.forEach(file => {
        Papa.parse(file, { header:true, skipEmptyLines:true, complete: res => {
            rawRows = rawRows.concat(res.data);
            pending--; if(pending===0) onCsvsLoaded();
        }, error: err=>{ console.error('Papa error',err); pending--; if(pending===0) onCsvsLoaded(); } });
    });
});

function onCsvsLoaded(){
    if(!rawRows.length) return;
    const cols = Object.keys(rawRows[0]);
    rows = rawRows.map(r=> normalizeRow(r, cols));
    populateUnidadeFilter();
    refreshAll();
}

// Populate Unidade select (global) and filterUnitForTop
function populateUnidadeFilter(){
    const s = document.getElementById('filtroUnidade');
    const s2 = document.getElementById('filterUnitForTop');
    const units = Array.from(new Set(rows.map(r=>r.Unidade))).sort();
    s.innerHTML = '<option value="">Todas as Unidades</option>' + units.map(u=>`<option value="${escapeHtml(u)}">${u}</option>`).join('');
    s2.innerHTML = '<option value="">Todas</option>' + units.map(u=>`<option value="${escapeHtml(u)}">${u}</option>`).join('');
}

// escape helper
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// Apply global filters (Unidade + Sexo + Faixa)
function applyGlobalFilters(data){
    const unit = document.getElementById('filtroUnidade').value;
    const sx = document.getElementById('filtroSexo').value;
    const fx = document.getElementById('filtroFaixa').value;
    return data.filter(r=>{
        if(unit && r.Unidade !== unit) return false;
        if(sx && r.Sexo !== sx) return false;
        if(fx && r.Faixa !== fx) return false;
        return true;
    });
}

// Refresh everything
function refreshAll(){
    const filtered = applyGlobalFilters(rows);
    // KPIs
    document.getElementById('kpiTotal').textContent = filtered.length;

    // media por dia
    const dayCounts = {};
    filtered.forEach(r=>{
        const d = r.DataAtendimento instanceof Date && !isNaN(r.DataAtendimento) ? r.DataAtendimento.toISOString().slice(0,10) : r.DataRaw || 'N/D';
        dayCounts[d] = (dayCounts[d]||0) + 1;
    });
    const keys = Object.keys(dayCounts).filter(k=>k!=='N/D');
    const media = keys.length ? (Object.values(dayCounts).reduce((a,b)=>a+b,0)/keys.length) : 0;
    document.getElementById('kpiMedia').textContent = media.toFixed(2);

    // pct sexo & idade media
    let soma=0, cnt=0; const sc={Masculino:0,Feminino:0,'N√ÉO INFORMADO':0,Outros:0};
    filtered.forEach(r=>{ if(r.Sexo==='Masculino') sc.Masculino++; else if(r.Sexo==='Feminino') sc.Feminino++; else if(r.Sexo==='N√ÉO INFORMADO') sc['N√ÉO INFORMADO']++; else sc.Outros++; if(r.Idade!=null && !isNaN(r.Idade)){soma+=r.Idade;cnt++;}});
    const pctM = filtered.length? Math.round((sc.Masculino/filtered.length)*100):0; const pctF = filtered.length? Math.round((sc.Feminino/filtered.length)*100):0;
    document.getElementById('pctM').textContent = `M: ${pctM}%`; document.getElementById('pctF').textContent = `F: ${pctF}%`;
    document.getElementById('kpiIdade').textContent = cnt? (soma/cnt).toFixed(1):'N/D';

    // top unidade/proc
    const unitCount = {}; const procCount = {};
    filtered.forEach(r=>{ unitCount[r.Unidade]=(unitCount[r.Unidade]||0)+1; procCount[r.Procedimento]=(procCount[r.Procedimento]||0)+1; });
    const mostUnit = Object.entries(unitCount).sort((a,b)=>b[1]-a[1])[0]; const mostProc = Object.entries(procCount).sort((a,b)=>b[1]-a[1])[0];
    document.getElementById('kpiTopUnidade').textContent = mostUnit? `${mostUnit[0]} (${mostUnit[1]})` : '‚Äî';
    document.getElementById('kpiTopProced').textContent = mostProc? `${mostProc[0]} (${mostProc[1]})` : '‚Äî';
    document.getElementById('mostUnit').textContent = mostUnit? `${mostUnit[0]} (${mostUnit[1]})` : '‚Äî';
    document.getElementById('mostProc').textContent = mostProc? `${mostProc[0]} (${mostProc[1]})` : '‚Äî';

    // Draw charts
    drawLineChart(dayCounts);
    drawSexChart(sc);
    drawAgeChart(filtered);
    drawTopProcChart(filtered);
    drawTopProfChart(filtered);
}

// CHARTS
function drawLineChart(dayCounts){
    const entries = Object.entries(dayCounts).filter(e=>e[0]!=='N/D').sort((a,b)=>a[0]<b[0]?-1:1);
    const labels = entries.map(e=>e[0]); const vals = entries.map(e=>e[1]);
    if(charts.line) charts.line.destroy();
    const ctx = document.getElementById('chartLineDay').getContext('2d');
    charts.line = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label:'Atendimentos/dia', data:vals, borderColor: 'rgba(10,132,255,1)', backgroundColor:'rgba(10,132,255,0.12)', fill:true, tension:0.2 }]}, options:{responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#bbb' }}, y:{ ticks:{ color:'#bbb' }, beginAtZero:true } }, plugins:{ legend:{ labels:{ color:'#fff' } } } });
}

function drawSexChart(sc){
    const labels = ['Masculino','Feminino','N√ÉO INFORMADO','Outros'];
    const data = labels.map(l=> sc[l]||0);
    if(charts.sex) charts.sex.destroy();
    const ctx = document.getElementById('chartSexPie').getContext('2d');
    charts.sex = new Chart(ctx, { type:'doughnut', data:{ labels, datasets:[{ data, backgroundColor:['#0a84ff','#ff6b9a','#95a5a6','#b2bec3'] }]}, options:{responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ color:'#fff' } } } });
}

function drawAgeChart(filtered){
    const order = ['0-5','6-17','18-24','25-39','40-59','60-79','80+','N/D'];
    const map = order.reduce((acc,k)=> (acc[k]=0, acc), {});
    filtered.forEach(r=> map[r.Faixa] = (map[r.Faixa]||0)+1);
    const labels = order; const data = labels.map(l=>map[l]||0);
    if(charts.age) charts.age.destroy();
    const ctx = document.getElementById('chartAgeBar').getContext('2d');
    charts.age = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ data, backgroundColor:'#ff7f50' }]}, options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#bbb' }, beginAtZero:true }, y:{ ticks:{ color:'#fff' } } }, plugins:{ legend:{ display:false } } });
}

function drawTopProcChart(filtered){
    const q = parseInt(document.getElementById('topN').value.replace('Top ','') || 10);
    const search = (document.getElementById('searchProc').value||'').toLowerCase();
    const map = {};
    filtered.forEach(r=>{ if(!search||r.Procedimento.toLowerCase().includes(search)) map[r.Procedimento] = (map[r.Procedimento]||0)+1; });
    const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,q);
    const labels = entries.map(e=>e[0]); const data = entries.map(e=>e[1]);
    document.getElementById('labelTopProc').textContent = q;
    if(charts.topProc) charts.topProc.destroy();
    const ctx = document.getElementById('chartTopProc').getContext('2d');
    charts.topProc = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ data, backgroundColor:'#27ae60' }]}, options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#bbb' }, beginAtZero:true }, y:{ ticks:{ color:'#fff' } } }, plugins:{ legend:{ display:false } } });
}

function drawTopProfChart(filtered){
    const q = parseInt(document.getElementById('topN').value.replace('Top ','') || 10);
    const search = (document.getElementById('searchProf').value||'').toLowerCase();
    const map = {};
    filtered.forEach(r=>{ if(!search||r.Profissional.toLowerCase().includes(search)) map[r.Profissional] = (map[r.Profissional]||0)+1; });
    const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,q);
    const labels = entries.map(e=>e[0]); const data = entries.map(e=>e[1]);
    document.getElementById('labelTopProf').textContent = q;
    if(charts.topProf) charts.topProf.destroy();
    const ctx = document.getElementById('chartTopProf').getContext('2d');
    charts.topProf = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ data, backgroundColor:'#0984e3' }]}, options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#bbb' }, beginAtZero:true }, y:{ ticks:{ color:'#fff' } } }, plugins:{ legend:{ display:false } } });
}

// Button handlers
document.getElementById('btnApply').addEventListener('click', ()=> refreshAll());
document.getElementById('btnReset').addEventListener('click', ()=>{
    document.getElementById('filtroUnidade').value = '';
    document.getElementById('filtroSexo').value = '';
    document.getElementById('filtroFaixa').value = '';
    document.getElementById('searchProc').value = '';
    document.getElementById('searchProf').value = '';
    document.getElementById('topN').value = 'Top 10';
    refreshAll();
});

// filter for 'Unidade / Procedimento' box
document.getElementById('filterUnitForTop').addEventListener('change', ()=>{
    const unit = document.getElementById('filterUnitForTop').value;
    // rebuild mostProc for that unit
    const filtered = unit? rows.filter(r=>r.Unidade===unit) : rows.slice();
    const procCount = {};
    filtered.forEach(r=> procCount[r.Procedimento] = (procCount[r.Procedimento]||0)+1);
    const top = Object.entries(procCount).sort((a,b)=>b[1]-a[1]).slice(0,10);
    document.getElementById('mostProc').textContent = top.length? `${top[0][0]} (${top[0][1]})` : '‚Äî';
});

// search inputs live
document.getElementById('searchProc').addEventListener('input', ()=> drawTopProcChart(applyGlobalFilters(rows)));
document.getElementById('searchProf').addEventListener('input', ()=> drawTopProfChart(applyGlobalFilters(rows)));
document.getElementById('topN').addEventListener('change', ()=> { drawTopProcChart(applyGlobalFilters(rows)); drawTopProfChart(applyGlobalFilters(rows)); });

</script>
<script>
// Exportar gr√°fico como PNG
const exportBtn = document.getElementById('exportPNG');
exportBtn.addEventListener('click', () => {
    const canvas = document.querySelector('canvas');
    const link = document.createElement('a');
    link.download = 'grafico.png';
    link.href = canvas.toDataURL();
    link.click();
});

// Filtrar por intervalo de datas
const aplicarData = document.getElementById('aplicarData');
aplicarData.addEventListener('click', () => {
    const inicio = document.getElementById('dataInicio').value;
    const fim = document.getElementById('dataFim').value;
    filtrarPorData(inicio, fim);
});
</script>
</body>
</html>
